"use strict";(self.webpackChunk_mlflow_mlflow=self.webpackChunk_mlflow_mlflow||[]).push([[7883],{7883:function(e,t,n){n.d(t,{$:function(){return tt}});var a=n(68248),i=n(27757),r=n(46709),o=n(12803),s=n(77680),l=n(76118);const d="mlflow.traceName",c=(e,t)=>{var n,a;return null===(n=e.request_metadata)||void 0===n||null===(a=n.find((({key:e})=>e===t)))||void 0===a?void 0:a.value},u=e=>c(e,"mlflow.sourceRun"),m=e=>c(e,"total_tokens"),g=e=>{const t=c(e,"mlflow.traceInputs");if(!(0,l.isNil)(t))try{return JSON.stringify(JSON.parse(t))}catch(n){return t}},p=e=>{const t=c(e,"mlflow.traceOutputs");if(!(0,l.isNil)(t))try{return JSON.stringify(JSON.parse(t))}catch(n){return t}},h=(e,t)=>{var n,a,i;return Array.isArray(e.tags)?null===(a=e.tags)||void 0===a||null===(i=a.find((({key:e})=>e===t)))||void 0===i?void 0:i.value:null===(n=e.tags)||void 0===n?void 0:n[t]},f=e=>h(e,d)||e.request_id,v=["timestamp_ms"],w="select";let b=function(e){return e.requestId="request_id",e.traceName="traceName",e.timestampMs="timestamp_ms",e.inputs="inputs",e.outputs="outputs",e.runName="runName",e.totalTokens="total_tokens",e.source="source",e.latency="latency",e.tags="tags",e.status="status",e}({});const S={[b.requestId]:(0,s.zR)({id:"0HqSXX",defaultMessage:"Request ID"}),[b.traceName]:(0,s.zR)({id:"60C/WF",defaultMessage:"Trace name"}),[b.timestampMs]:(0,s.zR)({id:"V3BImd",defaultMessage:"Time created"}),[b.status]:(0,s.zR)({id:"PBkS4s",defaultMessage:"Status"}),[b.inputs]:(0,s.zR)({id:"TQZ+X6",defaultMessage:"Request"}),[b.outputs]:(0,s.zR)({id:"pHAqL+",defaultMessage:"Response"}),[b.runName]:(0,s.zR)({id:"yltHdB",defaultMessage:"Run name"}),[b.totalTokens]:(0,s.zR)({id:"O5FKCr",defaultMessage:"Tokens"}),[b.source]:(0,s.zR)({id:"eM4+ab",defaultMessage:"Source"}),[b.latency]:(0,s.zR)({id:"6oYktw",defaultMessage:"Execution time"}),[b.tags]:(0,s.zR)({id:"4qVc2+",defaultMessage:"Tags"})},x={UNSET:null,IN_PROGRESS:(0,s.zR)({id:"y56Vz9",defaultMessage:"In progress"}),OK:(0,s.zR)({id:"Mn7Kss",defaultMessage:"OK"}),ERROR:(0,s.zR)({id:"igK5Su",defaultMessage:"Error"})};var y=n(28126);const k="request_metadata.`mlflow.sourceRun`",_="request_metadata.`mlflow.modelId`",C=e=>`run_id IN (${e.map((e=>`'${e}'`)).join(",")})`,Y=({experimentIds:e,sorting:t,filter:n="",runUuid:a,loggedModelId:i})=>{const[s,d]=(0,r.useState)([]),[c,m]=(0,r.useState)(!0),[g,p]=(0,r.useState)(void 0),h=(0,r.useMemo)((()=>{const e=(0,l.first)(t);return e&&v.includes(e.id)?`${e.id} ${e.desc?"DESC":"ASC"}`:"timestamp_ms DESC"}),[t]),f=(0,r.useMemo)((()=>a||i?i?n?`${n} AND ${_}='${i}'`:`${_}='${i}'`:n?`${n} AND ${k}='${a}'`:`${k}='${a}'`:n),[n,a,i]),[w,b]=(0,r.useState)({0:void 0}),[S,x]=(0,r.useState)(0),Y=w[S],I=(0,r.useCallback)((async({experimentIds:e,currentPage:t=0,pageToken:n,silent:a,orderByString:i="",filterString:r=""})=>{a||m(!0),p(void 0);try{const a=await o.x.getExperimentTraces(e,i,n,r);if(!a.traces)return void d([]);const s=await(async(e,t)=>{const n=t.reduce(((e,t)=>{const n=t.request_id,a=u(t);return n&&a?{...e,[n]:a}:e}),{}),a=(0,l.uniq)((0,l.values)(n));if(a.length<1)return{};const i=((await o.x.searchRuns({experiment_ids:e,filter:C(a),run_view_type:y.qi.ALL})).runs||[]).reduce(((e,t)=>({...e,[t.info.runUuid]:t.info.runName})),{});return t.reduce(((e,t)=>{const a=t.request_id;if(!a)return e;const r=n[a];return{...e,[a]:i[r]||r}}),{})})(e,a.traces),c=a.traces.map((e=>{const t=e.request_id;if(!t)return{...e};const n=s[t];return{...e,runName:n}}));d(c),b((e=>({...e,[t+1]:a.next_page_token})))}catch(s){p(s)}finally{m(!1)}}),[]),T=!c&&void 0!==w[S+1],M=!c&&(1===S||void 0!==w[S-1]);(0,r.useEffect)((()=>{I({experimentIds:e,filterString:f,orderByString:h})}),[I,f,e,h]);const R=(0,r.useCallback)((()=>{d([]),b({0:void 0}),x(0),I({experimentIds:e})}),[I,e]);return{traces:s,loading:c,error:g,hasNextPage:T,hasPreviousPage:M,fetchNextPage:(0,r.useCallback)((()=>{x((e=>e+1)),I({experimentIds:e,currentPage:S+1,pageToken:w[S+1],filterString:f,orderByString:h})}),[e,S,I,w,f,h]),fetchPrevPage:(0,r.useCallback)((()=>{x((e=>e-1)),I({experimentIds:e,currentPage:S-1,pageToken:w[S-1],filterString:f,orderByString:h})}),[e,S,I,w,f,h]),refreshCurrentPage:(0,r.useCallback)(((t=!1)=>I({experimentIds:e,currentPage:S,pageToken:Y,silent:t,filterString:f,orderByString:h})),[e,S,I,Y,f,h]),reset:R}};var I=n(74060),T=n(43617),M=n(90061),R=n(16389),A=n(91105),N=n(77153),D=n(60284),P=n(7655),E=n(40724),z=n(181),F=n(59281),q=n(73408);var $={name:"1wcfv52",styles:"margin-right:0"},H={name:"14cnl6e",styles:"flex-shrink:0;opacity:0;[role=row]:hover &{opacity:1;}[role=row]:focus-within &{opacity:1;}"};const O=({onAddEditTags:e,tags:t,baseComponentId:n})=>{const{theme:r}=(0,i.u)(),o=(null===t||void 0===t?void 0:t.filter((({key:e})=>e&&!e.startsWith(z.nt))))||[],s=o.length>0;return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",alignItems:"center",flexWrap:"wrap",columnGap:r.spacing.xs,rowGap:r.spacing.xs},""),children:[o.map((e=>(0,q.Y)(F.t,{tag:e,css:$,charLimit:20,maxWidth:150,enableFullViewModal:!0},e.key)))," ",(0,q.Y)(i.B,{componentId:`${n}.traces_table.edit_tag`,size:"small",icon:s?(0,q.Y)(I.PencilIcon,{}):void 0,onClick:e,children:s?void 0:(0,q.Y)(E.A,{id:"vHNP+J",defaultMessage:"Add tags"}),css:H,type:"tertiary"})]})};var L=n(66916);const B=(e,t)=>"IN_PROGRESS"===e?(0,q.Y)(L.C,{css:(0,a.AH)({color:t.colors.textValidationWarning},"")}):"OK"===e?(0,q.Y)(I.CheckCircleIcon,{css:(0,a.AH)({color:t.colors.textValidationSuccess},"")}):"ERROR"===e?(0,q.Y)(I.XCircleIcon,{css:(0,a.AH)({color:t.colors.textValidationDanger},"")}):null,U=({row:{original:e}})=>{const{theme:t}=(0,i.u)(),n=(0,P.A)(),r=x[e.status||"UNSET"];return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",gap:t.spacing.xs,alignItems:"center"},""),children:[B(e.status,t),r?n.formatMessage(r):""]})};var W=n(30676);const K={name:"rthgne",styles:"display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical"};var J={name:"ozd7xs",styles:"flex-shrink:0"};const V=({value:e,traceId:t,previewFieldName:n})=>{const{theme:s}=(0,i.u)(),[d,c]=(0,r.useState)(!1),[u,m]=(0,r.useState)(null),[g,p]=(0,r.useState)(!1),h=(0,r.useCallback)((async()=>{p(!0);try{const e=await o.x.getExperimentTraceData(t);if(n in e){const t=e[n],a=(0,l.isString)(t)?t:JSON.stringify(t);m(a)}}catch(e){const t=e instanceof N.s?e.getUserVisibleError():e.message;R.A.logErrorAndNotifyUser(`Error fetching response: ${t}`)}p(!1)}),[n,t]),f=e.length>=250;const v=(0,r.useCallback)((async()=>{!u&&f&&await h(),c(!0)}),[u,h,f]),w=(0,r.useCallback)((()=>{c(!1)}),[]);return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",gap:s.spacing.xs},""),children:[(0,q.Y)(i.B,{componentId:"mlflow.traces.traces_table.expand_cell_preview",size:"small",icon:d?(0,q.Y)(I.ChevronDownIcon,{}):(0,q.Y)(i.o,{}),onClick:d?w:v,css:J,loading:g,type:"primary"}),(0,q.Y)("div",{title:e,css:["overflow:hidden;text-overflow:ellipsis;",!d&&K,""],children:d?(0,q.Y)(j,{value:null!==u&&void 0!==u?u:e}):e})]})},j=({value:e})=>{const{theme:t}=(0,i.u)(),n=(0,r.useMemo)((()=>{try{const t=JSON.parse(e);return JSON.stringify(t,null,2)}catch(t){return null}}),[e]);return(0,q.Y)("div",{css:(0,a.AH)({whiteSpace:"pre-wrap",wordBreak:"break-word",fontFamily:n?"monospace":void 0},""),children:(0,q.Y)(W.z7,{language:"json",wrapLongLines:!0,style:{padding:t.spacing.sm},theme:t.isDarkMode?"duotoneDark":"light",children:n||e})})},G=({row:{original:e}})=>(0,q.Y)(V,{previewFieldName:"request",traceId:e.request_id||"",value:g(e)||""}),Z=({row:{original:e}})=>(0,q.Y)(V,{previewFieldName:"response",traceId:e.request_id||"",value:p(e)||""});var X=n(71625);const Q=({row:{original:e}})=>(0,q.Y)(X.t,{value:(0,l.keyBy)(e.tags,"key")}),ee=e=>`--header-${e}-size`,te=e=>`--col-${e}-size`,ne=r.memo((({row:e})=>{const{theme:t}=(0,i.u)();return(0,q.Y)("div",{role:"row","data-testid":"endpoints-list-table-rows",css:(0,a.AH)({minHeight:t.general.buttonHeight,display:"flex",flexDirection:"row",":hover":{backgroundColor:"var(--table-row-hover)"},paddingRight:"32px",borderBottom:"1px solid var(--table-separator-color)"},""),children:e.getAllCells().map((e=>{var n,a;const i=null===(n=e.column.columnDef.meta)||void 0===n?void 0:n.multiline,r=e.column.id===w?t.spacing.sm:`${t.spacing.sm}px ${t.spacing.xs}px`;return(0,q.Y)("div",{role:"cell",css:[{"--table-row-vertical-padding":`${t.spacing.sm}px`,flex:`calc(var(${te(e.column.id)}) / 100)`,overflow:"hidden",whiteSpace:i?"pre-wrap":"nowrap",textOverflow:i?"ellipsis":void 0,padding:r},null===(a=e.column.columnDef.meta)||void 0===a?void 0:a.styles,""],children:(0,T.Kv)(e.column.columnDef.cell,e.getContext())},e.id)}))},e.id)}),((e,t)=>e.columns===t.columns&&e.selected===t.selected&&(0,l.isEqual)(e.row.original.tags,t.row.original.tags))),ae=r.memo((({row:{original:e}})=>e.timestamp_ms?(0,q.Y)(I.LegacyTooltip,{title:new Date(e.timestamp_ms).toLocaleString(navigator.language,{timeZoneName:"short"}),placement:"right",children:(0,q.Y)("span",{children:R.A.timeSinceStr(e.timestamp_ms)})}):null),(()=>!0)),ie=({table:e})=>{const t=e.getIsAllRowsSelected()||!!e.getIsSomeRowsSelected()&&null;return(0,q.Y)(I.Checkbox,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracesviewtableheadercheckbox.tsx_14","data-testid":"trace-table-header-checkbox",isChecked:t,wrapperStyle:{padding:0,margin:0},onChange:e.toggleAllRowsSelected})},re=({row:e})=>(0,q.Y)(I.Checkbox,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracesviewtablecellcheckbox.tsx_12","data-testid":`trace-table-cell-checkbox-${e.id}`,disabled:!e.getCanSelect(),isChecked:e.getIsSelected(),wrapperStyle:{padding:0,margin:0},onChange:()=>e.toggleSelected()});var oe=n(39767),se=n(31655);var le={name:"s09txq",styles:"max-width:100%;text-overflow:ellipsis"};const de=({row:{original:e},table:{options:{meta:t}}})=>{const{baseComponentId:n,onTraceClicked:a}=t;return(0,q.Y)(i.T.Link,{componentId:`${n}.traces_table.request_id_link`,ellipsis:!0,css:le,onClick:()=>{null===a||void 0===a||a(e)},children:e.request_id})};var ce={name:"s09txq",styles:"max-width:100%;text-overflow:ellipsis"};const ue=({row:{original:e},table:{options:{meta:t}}})=>{const{baseComponentId:n,onTraceClicked:a}=t;return(0,q.Y)(i.T.Link,{componentId:`${n}.traces_table.trace_name_link`,ellipsis:!0,css:ce,onClick:()=>{null===a||void 0===a||a(e)},children:h(e,d)})};var me={name:"hgn0g7",styles:"max-width:100%;text-overflow:ellipsis;display:inline-block;overflow:hidden"};const ge=({row:{original:e}})=>{const t=u(e);if(!t||!e.experiment_id)return null;const n=e.runName||t;return(0,q.Y)(A.N_,{css:me,to:D.Ay.getRunPageRoute(e.experiment_id,t),children:n})},pe=({row:{original:e},table:{options:{meta:t}}})=>{const{onTraceTagsEdit:n,baseComponentId:a}=t;return(0,q.Y)(O,{tags:e.tags||[],onAddEditTags:()=>null===n||void 0===n?void 0:n(e),baseComponentId:a})};var he={name:"s09txq",styles:"max-width:100%;text-overflow:ellipsis"},fe={name:"s09txq",styles:"max-width:100%;text-overflow:ellipsis"},ve={name:"hgn0g7",styles:"max-width:100%;text-overflow:ellipsis;display:inline-block;overflow:hidden"};const we=r.memo((({experimentIds:e,runUuid:t,traces:n,loading:a,error:o,onTraceClicked:s,onTraceTagsEdit:c,hasNextPage:g,hasPreviousPage:p,onNextPage:f,onPreviousPage:v,usingFilters:x,onResetFilters:y,sorting:k,setSorting:_,rowSelection:C,setRowSelection:Y,hiddenColumns:z=[],disableTokenColumn:F,baseComponentId:$,toggleHiddenColumn:H,disabledColumns:L=[]})=>{const B=(0,P.A)(),{theme:W}=(0,i.u)(),K=!a&&0===n.length&&!x&&!o,J=(0,se.rR)(),V=(0,r.useMemo)((()=>(0,l.entries)(S).map((([e,t])=>({key:e,label:B.formatMessage(t)}))).filter((({key:e})=>!L.includes(e)))),[B,L]),j=(0,r.useMemo)((()=>{if(K)return[];const e=[{id:w,header:ie,enableResizing:!1,enableSorting:!1,cell:re,meta:{styles:{minWidth:32,maxWidth:32}}},{header:B.formatMessage(S[b.requestId]),enableSorting:!1,enableResizing:!0,id:b.requestId,cell:J?de:({row:{original:e}})=>(0,q.Y)(i.T.Link,{componentId:`${$}.traces_table.request_id_link`,ellipsis:!0,css:he,onClick:()=>{null===s||void 0===s||s(e)},children:e.request_id}),meta:{styles:{minWidth:200}}},{header:B.formatMessage(S[b.traceName]),enableSorting:!1,enableResizing:!0,id:b.traceName,cell:J?ue:({row:{original:e}})=>(0,q.Y)(i.T.Link,{componentId:`${$}.traces_table.trace_name_link`,ellipsis:!0,css:fe,onClick:()=>{null===s||void 0===s||s(e)},children:h(e,d)}),meta:{styles:{minWidth:150}}},{header:B.formatMessage(S[b.timestampMs]),id:b.timestampMs,accessorFn:e=>e.timestamp_ms,enableSorting:!0,enableResizing:!0,cell:ae,meta:{styles:{minWidth:100}}},{header:B.formatMessage(S[b.status]),id:b.status,enableSorting:!1,enableResizing:!0,cell:U,meta:{styles:{minWidth:100}}},{header:B.formatMessage(S[b.inputs]),id:b.inputs,enableSorting:!1,enableResizing:!0,cell:G,meta:{multiline:!0}},{header:B.formatMessage(S[b.outputs]),enableSorting:!1,enableResizing:!0,id:b.outputs,cell:Z,meta:{multiline:!0}},{header:B.formatMessage(S[b.runName]),enableSorting:!1,enableResizing:!0,id:b.runName,cell:J?ge:({row:{original:e}})=>{const t=u(e);if(!t||!e.experiment_id)return null;const n=e.runName||t;return(0,q.Y)(A.N_,{css:ve,to:D.Ay.getRunPageRoute(e.experiment_id,t),children:n})}},{header:B.formatMessage(S[b.source]),enableSorting:!0,enableResizing:!0,id:b.source,cell:Q,meta:{styles:{minWidth:100}}}];return F||e.push({header:B.formatMessage(S[b.totalTokens]),enableSorting:!1,enableResizing:!0,id:b.totalTokens,accessorFn:e=>m(e),meta:{styles:{minWidth:80,maxWidth:80}}}),e.push({header:B.formatMessage(S[b.latency]),enableSorting:!1,enableResizing:!0,id:b.latency,accessorFn:e=>(0,l.isNil)(e.execution_time_ms)||!isFinite(e.execution_time_ms)?null:R.A.formatDuration(e.execution_time_ms),meta:{styles:{minWidth:100}}},{header:B.formatMessage(S[b.tags]),enableSorting:!1,enableResizing:!0,id:b.tags,cell:J?pe:({row:{original:e}})=>(0,q.Y)(O,{tags:e.tags||[],onAddEditTags:()=>null===c||void 0===c?void 0:c(e),baseComponentId:$})}),e.filter((e=>e.id&&!z.includes(e.id)))}),[B,s,c,F,z,$,J,K]),X=(0,T.N4)({columns:j,data:K?[]:n,state:{sorting:k,rowSelection:C},getCoreRowModel:(0,M.HT)(),getRowId:(e,t)=>e.request_id||t.toString(),getSortedRowModel:(0,M.h5)(),onSortingChange:_,onRowSelectionChange:Y,enableColumnResizing:!0,enableRowSelection:!0,columnResizeMode:"onChange",meta:{baseComponentId:$,onTraceClicked:s,onTraceTagsEdit:c}}),le=X.getState().columnSizingInfo,ce=r.useMemo((()=>{if(K)return{};const e=X.getFlatHeaders(),t={};return e.forEach((e=>{t[ee(e.id)]=e.getSize(),t[te(e.column.id)]=e.column.getSize()})),t}),[le,j,X,K]);return K?(0,q.Y)(oe.i,{baseComponentId:$,runUuid:t}):(0,q.FD)(I.Table,{scrollable:!0,empty:(()=>{if(o){const e=o instanceof N.s?o.getMessageField():o.message;return(0,q.Y)(I.Empty,{image:(0,q.Y)(i.k,{}),description:e,title:(0,q.Y)(E.A,{id:"Cj2i02",defaultMessage:"Error"})})}return!a&&0===n.length&&x?(0,q.Y)(I.Empty,{description:(0,q.Y)(E.A,{id:"LTe7m4",defaultMessage:"No traces found with the current filter query. <button>Reset filters</button> to see all traces.",values:{button:e=>(0,q.Y)(i.T.Link,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracesviewtable.tsx_289",onClick:y,children:e})}}),title:(0,q.Y)(E.A,{id:"yeEPjS",defaultMessage:"No traces found"})}):null})(),style:ce,pagination:(0,q.Y)(I.CursorPagination,{componentId:`${$}.traces_table.pagination`,hasNextPage:g,hasPreviousPage:p,onNextPage:f,onPreviousPage:v}),children:[(0,q.FD)(I.TableRow,{isHeader:!0,children:[X.getLeafHeaders().map((e=>{var t;return(0,q.Y)(I.TableHeader,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracesviewtable.tsx_365",css:null===(t=e.column.columnDef.meta)||void 0===t?void 0:t.styles,sortable:e.column.getCanSort(),sortDirection:e.column.getIsSorted()||"none",onToggleSort:e.column.getToggleSortingHandler(),header:e,column:e.column,setColumnSizing:X.setColumnSizing,isResizing:e.column.getIsResizing(),style:{flex:`calc(var(${ee(e.id)}) / 100)`},children:(0,T.Kv)(e.column.columnDef.header,e.getContext())},e.id)})),(0,q.Y)(I.TableRowAction,{children:(0,q.FD)(I.DropdownMenu.Root,{children:[(0,q.Y)(I.DropdownMenu.Trigger,{asChild:!0,children:(0,q.Y)(i.B,{componentId:`${$}.traces_table.column_selector_dropdown`,icon:(0,q.Y)(I.ColumnsIcon,{}),size:"small","aria-label":B.formatMessage({id:"zd5Jw4",defaultMessage:"Select columns"})})}),(0,q.Y)(I.DropdownMenu.Content,{align:"end",children:V.map((({key:e,label:t})=>(0,q.FD)(I.DropdownMenu.CheckboxItem,{componentId:`${$}.traces_table.column_toggle_button`,checked:!z.includes(e),onClick:()=>H(e),children:[(0,q.Y)(I.DropdownMenu.ItemIndicator,{}),t]},e)))})]})})]}),a&&(0,q.Y)(I.TableSkeletonRows,{table:X}),!a&&!o&&X.getRowModel().rows.map((e=>(0,q.Y)(ne,{row:e,columns:j,selected:C[e.id]},e.id)))]})}));var be=n(79081);var Se=n(72150);const xe=({requestId:e,traceInfo:t,loadingTraceInfo:n,onClose:s,selectedSpanId:l,onSelectSpan:d})=>{const{traceData:c,loading:u,error:m}=((e,t=!1)=>{const[n,a]=(0,r.useState)(void 0),[i,s]=(0,r.useState)(!1),[l,d]=(0,r.useState)(void 0),c=(0,r.useCallback)((async e=>{s(!0);try{const t=await o.x.getExperimentTraceData(e);Array.isArray(t.spans)?a(t):R.A.logErrorAndNotifyUser("Invalid trace data response: "+JSON.stringify(null===t||void 0===t?void 0:t.toString()))}catch(t){d(t)}s(!1)}),[]);return(0,r.useEffect)((()=>{e&&!t&&c(e)}),[c,e,t]),{traceData:n,loading:i,error:l}})(e,"IN_PROGRESS"===(null===t||void 0===t?void 0:t.status)),{theme:g}=(0,i.u)(),p=!n&&!t,{traceInfo:h,loading:v}=((e,t=!0)=>{const[n,a]=(0,r.useState)(void 0),[i,s]=(0,r.useState)(t),[l,d]=(0,r.useState)(void 0),c=(0,r.useCallback)((async()=>{if(t){d(void 0);try{const t=await o.x.getExperimentTraceInfo(e);if(!t.trace_info)return void a(void 0);a(t.trace_info)}catch(n){d(n)}finally{s(!1)}}}),[t,e]);return(0,r.useEffect)((()=>{c()}),[c]),{traceInfo:n,loading:i,error:l}})(e,p),w=t||h,b=(0,r.useMemo)((()=>n||v?(0,q.Y)(I.TitleSkeleton,{}):w?(0,q.Y)(i.T.Title,{level:2,withoutMargins:!0,children:f(w)}):e),[n,v,w,e]),S=(0,r.useMemo)((()=>c?{info:w||{},data:c}:void 0),[c,w]),x=((null===c||void 0===c?void 0:c.spans)||[]).length>0;return(0,q.Y)(I.Drawer.Root,{modal:!0,open:!0,onOpenChange:e=>{e||s()},children:(0,q.Y)(I.Drawer.Content,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracedatadrawer.tsx_222",width:"90vw",title:b,expandContentToFullHeight:!0,children:u||n||v?(0,q.Y)(Se.ModelTraceExplorerSkeleton,{}):"IN_PROGRESS"===(null===t||void 0===t?void 0:t.status)?(0,q.FD)(q.FK,{children:[(0,q.Y)(be.S,{size:"lg"}),(0,q.Y)(I.Empty,{image:(0,q.Y)(i.W,{}),description:(0,q.Y)(E.A,{id:"K+5g8S",defaultMessage:"Trace data is not available for in-progress traces. Please wait for the trace to complete."}),title:(0,q.Y)(E.A,{id:"p0O0uP",defaultMessage:"Trace data not available"})})]}):m?(0,q.FD)(q.FK,{children:[(0,q.Y)(be.S,{size:"lg"}),(0,q.Y)(I.Empty,{image:(0,q.Y)(i.k,{}),description:(0,q.Y)(E.A,{id:"c4KA32",defaultMessage:"An error occurred while attempting to fetch the trace data. Please wait a moment and try again."}),title:(0,q.Y)(E.A,{id:"eavoW/",defaultMessage:"Error"})})]}):x?S?(0,q.Y)("div",{css:(0,a.AH)({height:"100%",marginLeft:-g.spacing.lg,marginRight:-g.spacing.lg,marginBottom:-g.spacing.lg},""),onWheel:e=>e.stopPropagation(),children:(0,q.Y)(Se.ModelTraceExplorer,{modelTrace:S,selectedSpanId:l,onSelectSpan:d})}):null:(0,q.FD)(q.FK,{children:[(0,q.Y)(be.S,{size:"lg"}),(0,q.Y)(I.Empty,{description:null,title:(0,q.Y)(E.A,{id:"EpFST9",defaultMessage:"No trace data recorded"})})]})})})};var ye=n(88525);const ke=({experimentIds:e,visible:t,rowSelection:n,setRowSelection:a,handleClose:s,refreshTraces:d})=>{const c=(0,P.A)(),[u,m]=(0,r.useState)(""),[g,p]=(0,r.useState)(!1),h=(0,l.keys)((0,l.pickBy)(n,(e=>e)));return(0,q.FD)(be.d,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracesviewdeletetracemodal.tsx_62",title:(0,q.Y)(E.A,{id:"gRz1nB",defaultMessage:"{count, plural, one {Delete Trace} other {Delete Traces}}",values:{count:h.length}}),visible:t,onCancel:s,okText:(0,q.Y)(E.A,{id:"g56Cuk",defaultMessage:"Delete {count, plural, one { # trace } other { # traces }}",values:{count:h.length}}),onOk:()=>{(async()=>{try{var t;await o.x.deleteTraces(null!==(t=e[0])&&void 0!==t?t:"",h),a({}),d(),s()}catch(n){m(c.formatMessage({id:"zhzZUu",defaultMessage:"An error occured while attempting to delete traces. Please refresh the page and try again."}))}p(!1)})(),p(!0)},okButtonProps:{loading:g,danger:!0},children:[u&&(0,q.Y)(i.T.Paragraph,{color:"error",children:u}),(0,q.Y)(i.T.Paragraph,{children:(0,q.Y)(i.T.Text,{bold:!0,children:(0,q.Y)(E.A,{id:"kmtWGf",defaultMessage:"{count, plural, one { # trace } other { # traces }} will be deleted.",values:{count:h.length}})})}),(0,q.Y)(i.T.Paragraph,{children:(0,q.Y)(E.A,{id:"VfGJFc",defaultMessage:"Deleted traces cannot be restored. Are you sure you want to proceed?"})})]})},_e=({experimentIds:e,rowSelection:t,setRowSelection:n,refreshTraces:o,baseComponentId:s})=>{const[l,d]=(0,r.useState)(!1),{theme:c}=(0,i.u)(),u=(0,r.useCallback)((()=>{d(!0)}),[d]),m=(0,r.useCallback)((()=>{d(!1)}),[d]);return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",flexDirection:"row",alignItems:"center",gap:c.spacing.sm},""),children:[(0,q.Y)(i.B,{componentId:`${s}.traces_table.delete_traces`,onClick:u,danger:!0,children:(0,q.Y)(E.A,{id:"QAyzA3",defaultMessage:"Delete"})}),(0,q.Y)(ke,{experimentIds:e,visible:l,rowSelection:t,handleClose:m,refreshTraces:o,setRowSelection:n})]})};const Ce=({baseComponentId:e})=>{const{theme:t}=(0,i.u)();return(0,q.FD)(i.aw.Root,{componentId:"codegen_mlflow_app_src_experiment-tracking_components_traces_tracesviewcontrols.tsx_28",modal:!1,children:[(0,q.Y)(i.aw.Trigger,{asChild:!0,children:(0,q.Y)(i.B,{size:"small",type:"link",icon:(0,q.Y)(be.I,{css:(0,a.AH)({svg:{width:16,height:16,color:t.colors.textSecondary}},"")}),componentId:`${e}.traces_table.filter_tooltip`})}),(0,q.FD)(i.aw.Content,{children:[(0,q.Y)(i.aw.Arrow,{}),(0,q.Y)(i.T.Paragraph,{children:(0,q.Y)(E.A,{id:"2Ofya9",defaultMessage:"Search traces using a simplified version of the SQL {whereBold} clause.",values:{whereBold:(0,q.Y)("b",{children:"WHERE"})}})}),(0,q.Y)(E.A,{id:"U3btBc",defaultMessage:"Examples:"}),(0,q.Y)("ul",{children:(0,q.Y)("li",{children:(0,q.Y)("code",{children:'tags.some_tag = "abc"'})})})]})]})};var Ye={name:"1ykowef",styles:"margin-bottom:0"},Ie={name:"ikeoj9",styles:"width:430px"};const Te=({experimentIds:e,filter:t,onChangeFilter:n,rowSelection:o,setRowSelection:s,refreshTraces:l,baseComponentId:d,runUuid:c,traces:u})=>{const m=(0,P.A)(),{theme:g}=(0,i.u)(),[p,h]=(0,r.useState)(t||void 0),[f,v]=(0,r.useState)(!1),w=null!==p&&void 0!==p?p:t,b=Object.entries(o).filter((([,e])=>e)).map((([e])=>e)).length>0?(0,q.Y)(_e,{experimentIds:e,rowSelection:o,setRowSelection:s,refreshTraces:l,baseComponentId:d}):(0,q.Y)(I.TableFilterLayout,{css:Ye,children:(0,q.Y)(L.I,{componentId:`${d}.traces_table.search_filter`,placeholder:m.formatMessage({id:"FPMrvd",defaultMessage:"Search traces"}),value:w,css:Ie,onChange:e=>h(e.target.value),prefix:(0,q.Y)(L.S,{}),suffix:(0,q.Y)(Ce,{baseComponentId:d}),allowClear:!0,onClear:()=>{n(""),h(void 0)},onKeyDown:e=>{"Enter"===e.key&&(n(w),h(void 0))}})});return(0,q.Y)("div",{css:(0,a.AH)({display:"flex",gap:g.spacing.xs},""),children:b})};var Me=n(58355);const Re={hiddenColumns:[b.traceName,b.source]},Ae=e=>{const t=(0,r.useMemo)((()=>{const t=JSON.stringify(e.slice().sort());return Me.A.getStoreForComponent("ExperimentViewTraces",t)}),[e]),[n,a]=(0,r.useState)((()=>(e=>{try{const t=e.getItem("uiState"),n=JSON.parse(t);return(0,l.isObject)(n)?n:Re}catch(t){return Re}})(t))),i=(0,r.useCallback)((e=>{a((t=>{const n=t.hiddenColumns||[];return{hiddenColumns:n.includes(e)?n.filter((t=>t!==e)):[...n,e]}}))}),[]);return(0,r.useEffect)((()=>{t.setItem("uiState",JSON.stringify(n))}),[t,n]),{uiState:n,toggleHiddenColumn:i}},Ne="selectedTraceId",De="selectedSpanId",Pe=[{id:b.timestampMs,desc:!0}],Ee=({experimentIds:e,runUuid:t,loggedModelId:n,disabledColumns:o,baseComponentId:s=(t?"mlflow.run.traces":"mlflow.experiment_page.traces")})=>{const d=(0,r.useRef)(void 0),[c,u]=(0,r.useState)(""),[g,p]=(0,r.useState)(Pe),[h,f]=(0,r.useState)({}),[v,w]=(()=>{var e;const[t,n]=(0,A.ok)(),a=null!==(e=t.get(Ne))&&void 0!==e?e:void 0,i=(0,r.useCallback)((e=>{n((t=>void 0===e?(t.delete(Ne),t):(t.set(Ne,e),t)))}),[n]);return[a,i]})(),[S,x]=(()=>{var e;const[t,n]=(0,A.ok)(),a=null!==(e=t.get(De))&&void 0!==e?e:void 0,i=(0,r.useCallback)((e=>{n((t=>void 0===e?(t.delete(De),t):(t.set(De,e),t)),{replace:!0})}),[n]);return[a,i]})(),{traces:y,loading:k,error:_,hasNextPage:C,hasPreviousPage:I,fetchNextPage:T,fetchPrevPage:M,refreshCurrentPage:R}=Y({experimentIds:e,sorting:g,filter:c,runUuid:t,loggedModelId:n}),N=(0,r.useCallback)((({request_id:e})=>w(e)),[w]),D=(0,r.useCallback)((()=>{T(),f({})}),[T]),P=(0,r.useCallback)((()=>{M(),f({})}),[M]);(0,r.useEffect)((()=>{window.clearTimeout(d.current);const e=async()=>{k||I||(await R(!0),window.clearTimeout(d.current),d.current=window.setTimeout(e,3e4))};return d.current=window.setTimeout(e,3e4),()=>window.clearTimeout(d.current)}),[R,k,I]);const{theme:E}=(0,i.u)(),z=(0,r.useMemo)((()=>{if(v)return y.find((e=>e.request_id===v))}),[v,y]),{uiState:F,toggleHiddenColumn:$}=Ae(e),H=(0,r.useMemo)((()=>(0,l.uniq)((0,l.compact)(y.flatMap((e=>{var t;return null===(t=e.tags)||void 0===t?void 0:t.map((e=>e.key))}))))),[y]),{showEditTagsModalForTrace:O,EditTagsModal:L}=(0,ye.$)({onSuccess:()=>R(!0),existingTagKeys:H}),B=""!==c,U=y.some((e=>!(0,l.isNil)(m(e)))),W=(0,r.useMemo)((()=>U?[]:[b.totalTokens]),[U]),K=(0,r.useMemo)((()=>[...null!==o&&void 0!==o?o:[],...W]),[o,W]),J=(0,r.useMemo)((()=>{var e;return[...null!==(e=F.hiddenColumns)&&void 0!==e?e:[],...K]}),[F,K]);return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",flexDirection:"column",gap:E.spacing.sm,height:"100%",overflow:"hidden"},""),children:[(0,q.Y)(Te,{experimentIds:e,filter:c,onChangeFilter:u,rowSelection:h,setRowSelection:f,refreshTraces:R,baseComponentId:s,runUuid:t,traces:y}),(0,q.Y)(we,{experimentIds:e,runUuid:t,traces:y,loading:k,error:_,onTraceClicked:N,onTraceTagsEdit:O,hasNextPage:C,hasPreviousPage:I,onPreviousPage:P,onNextPage:D,onTagsUpdated:R,usingFilters:B,onResetFilters:()=>u(""),hiddenColumns:J,disableTokenColumn:!U,disabledColumns:K,setSorting:e=>{if((0,l.isFunction)(e))return p((t=>{const n=e(t),a=t[0];return n&&0!==n.length||!a?n:[{id:a.id,desc:!a.desc}]}))},sorting:g,rowSelection:h,setRowSelection:f,baseComponentId:s,toggleHiddenColumn:$}),v&&(0,q.Y)(xe,{traceInfo:z,loadingTraceInfo:k,requestId:v,onClose:()=>w(void 0),selectedSpanId:S,onSelectSpan:x}),L]})};var ze=n(92831),Fe=n(42747),qe=n(92338),$e=n(14429),He=n(16453),Oe=n(79444),Le=n(39595),Be=n(92388);const Ue=r.memo((()=>{const e=(0,Fe.tz)(),{theme:t}=(0,i.u)(),n=(0,Le.jE)(),o=(0,Be.C)({queryKey:[ze.TH]}),[s,d]=(0,$e.VA)(),c=(0,r.useMemo)((()=>(0,qe.p)(e)),[e]),u=e.formatMessage({id:"BJvcsS",defaultMessage:"Time Range"}),m=(0,Oe.U)();return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",gap:t.spacing.sm,alignItems:"center"},""),children:[(0,q.FD)(I.DialogCombobox,{componentId:"mlflow.experiment-evaluation-monitoring.date-selector",label:u,value:s.startTimeLabel?[s.startTimeLabel]:[$e.oy],children:[(0,q.Y)(I.DialogComboboxTrigger,{renderDisplayedValue:e=>{var t;return null===(t=c.find((t=>t.key===e)))||void 0===t?void 0:t.label},allowClear:!(0,l.isNil)(s.startTimeLabel)&&s.startTimeLabel!==$e.oy,onClear:()=>{d({startTimeLabel:$e.oy})},"data-testid":"time-range-select-dropdown"}),(0,q.Y)(I.DialogComboboxContent,{children:(0,q.Y)(I.DialogComboboxOptionList,{children:c.map((e=>(0,q.Y)(I.DialogComboboxOptionListSelectItem,{checked:s.startTimeLabel===e.key||e.key===$e.oy&&(0,l.isNil)(s.startTimeLabel),title:e.label,"data-testid":`time-range-select-${e}`,value:e.key,onChange:()=>{d({...s,startTimeLabel:e.key})},children:e.label},e.key)))})})]}),"CUSTOM"===s.startTimeLabel&&(0,q.Y)(q.FK,{children:(0,q.Y)(He.cv,{id:"date-picker-range",includeTime:!0,selected:{from:new Date(s.startTime),to:s.endTime?new Date(s.endTime):m.dateNow},onChange:e=>{const t=e.target.value;d({...s,startTime:null!==t&&void 0!==t&&t.from?t.from.toISOString():void 0,endTime:null!==t&&void 0!==t&&t.to?t.to.toISOString():void 0})},startDatePickerProps:{componentId:"experiment-evaluation-monitoring-start-date-picker",datePickerProps:{disabled:{after:m.dateNow}},value:s.startTime?new Date(s.startTime):void 0},endDatePickerProps:{componentId:"experiment-evaluation-monitoring-end-date-picker",datePickerProps:{disabled:{after:m.dateNow}},value:s.endTime?new Date(s.endTime):void 0}})}),(0,q.Y)(be.T,{componentId:"mlflow.experiment-evaluation-monitoring.trace-info-hover-request-time",content:e.formatMessage({id:"Arvaod",defaultMessage:"Showing data up to {date}."},{date:m.dateNow.toLocaleString(navigator.language,{timeZoneName:"short"})}),children:(0,q.Y)(i.B,{type:"link",componentId:"mlflow.experiment-evaluation-monitoring.refresh-date-button",disabled:Boolean(o),onClick:()=>{m.refresh(),(0,ze.BL)({queryClient:n})},children:(0,q.Y)(I.RefreshIcon,{})})})]})}));var We=n(85167),Ke=n(89949);var Je={name:"1vfb318",styles:"flex:1;display:flex;align-items:center;justify-content:center"};const Ve=({error:e})=>{var t;return(0,q.Y)(I.PageWrapper,{css:Je,children:(0,q.Y)(I.Empty,{"data-testid":"fallback",title:(0,q.Y)(E.A,{id:"FbAMd+",defaultMessage:"Error"}),description:null!==(t=null===e||void 0===e?void 0:e.message)&&void 0!==t?t:(0,q.Y)(E.A,{id:"CbzDeZ",defaultMessage:"An error occurred while rendering this component."}),image:(0,q.Y)(i.k,{})})})},je=({children:e})=>(0,q.Y)(Ke.tH,{fallback:(0,q.Y)(Ve,{}),children:e}),Ge="viewState",Ze=()=>{const{theme:e}=(0,i.u)();return(0,q.Y)("div",{css:(0,a.AH)({display:"flex",alignItems:"center",width:"100%",borderBottom:`1px solid ${e.colors.grey100}`,paddingBottom:`${e.spacing.sm}px`},""),children:(0,q.Y)(Ue,{})})},Xe=({viewState:e,experimentId:t,endpointName:n,timeRange:a})=>"logs"===e?(0,q.Y)(We.v,{experimentId:t||"",endpointName:n||"",timeRange:a}):null,Qe=({experimentIds:e})=>{const{theme:t}=(0,i.u)(),[n,o]=(0,$e.VA)(),s=(0,Oe.U)(),l=e[0],[d]=(()=>{var e;const[t,n]=(0,A.ok)(),a=null!==(e=t.get(Ge))&&void 0!==e?e:"logs",i=(0,r.useCallback)(((e,t=!1)=>{n((t=>void 0===e?(t.delete(Ge),t):(t.set(Ge,e),t)),{replace:t})}),[n]);return[a,i]})(),c=(0,r.useMemo)((()=>{const{startTime:e,endTime:t}=(0,$e.UY)(s.dateNow,n);return{startTime:e?new Date(e).getTime().toString():void 0,endTime:t?new Date(t).getTime().toString():void 0}}),[s.dateNow,n]);return(0,q.FD)("div",{css:(0,a.AH)({display:"flex",flexDirection:"column",gap:t.spacing.sm,height:"100%",overflowY:"hidden"},""),children:[(0,se.$Y)()&&(0,q.Y)(Ze,{}),(0,q.Y)(Xe,{viewState:d,experimentId:l,timeRange:c})]})},et=({experimentIds:e})=>(0,q.Y)(je,{children:(0,q.Y)(Oe.k,{children:(0,q.Y)(Qe,{experimentIds:e})})}),tt=({experimentIds:e})=>{const{theme:t}=(0,i.u)();return(0,q.Y)("div",{css:(0,a.AH)({minHeight:225,display:"flex",flexDirection:"column",gap:t.spacing.sm,flex:1,overflow:"hidden"},""),children:(0,q.Y)(nt,{experimentIds:e})})},nt=({experimentIds:e})=>(0,se.v3)()||(0,se.$Y)()?(0,q.Y)(et,{experimentIds:e}):(0,q.Y)(Ee,{experimentIds:e})}}]);